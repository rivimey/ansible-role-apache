# {{ ansible_managed }}
#
# Set up VirtualHost for {{ vhost.servername }}

{% set status_url = vhost.status_url | default("/server-status") %}
<VirtualHost {{ apache_listen_ip }}:{{ apache_listen_port }}>
  ServerName {{ vhost.servername }}
{% if vhost.serveralias is defined %}
  ServerAlias {{ vhost.serveralias }}
{% endif %}
{% if vhost.serveradmin is defined %}
  ServerAdmin {{ vhost.serveradmin }}
{% endif %}
{% if vhost.httpprotos is defined %}
  Protocols "{{ vhost.httpprotos | default(apache_httpprotos) }}"
{% endif %}
  ErrorLog /var/log/apache2/{{ vhost.servername }}-errors.log
  CustomLog /var/log/apache2/{{ vhost.servername }}-access.log combined
  LogLevel warn
  TimeOut 60

{% if vhost.serverstatus is defined and vhost.serverstatus %}
  <IfModule mod_status.c>
  # Allow server status reports generated by mod_status,
  # with the URL of http://servername{{ status_url }}>
  # Uncomment and change the "192.0.2.0/24" to allow access from other hosts.
  <Location {{ status_url }}>
    SetHandler server-status
    Require local
  </Location>
  # Determine if mod_status shows the first 63 characters of a request or the last.
  #SeeRequestTail On
  </IfModule>
{% else %}
  <Location {{ status_url }}>
    Require all denied
  </Location>
{% endif -%}

{% if vhost.redirectssl is defined and vhost.redirectssl %}
  <IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !={{ status_url }}>
    RewriteCond %{HTTPS} !=on
    RewriteRule ^/?(.*) https://{{ vhost.servername }}/$1 [R,L]
  </IfModule>
{% else -%}
{% if vhost.documentroot is defined %}
  DocumentRoot "{{ vhost.documentroot }}"
{% endif -%}
{% if vhost.reverseproxy is defined -%}
  <IfModule mod_proxy.c>
{% for proxy in vhost.reverseproxy %}
  <Location {{ proxy.dir  }}>
    ProxyPass {{ proxy.url }}
    ProxyPassReverse {{ proxy.url }}
{% if proxy.preservehost is defined %}
    ProxyPreserveHost {{proxy.preservehost |as_on_off }}
{% endif %} {#- preservehost #}
{% if proxy.proxyheaders is defined %}
    ProxyAddHeaders {{proxy.proxyheaders |as_on_off }}
{% endif %} {#- proxyheaders #}
  </Location>
{% endfor -%}
  </IfModule>
{% endif %} {#- reverseproxy #}

{% if vhost.php_fpm is defined %}
  # Check vhost.php_fpm: {{ vhost.php_fpm |default("-") }} php_version: {{ php_version |default("-") }}
  DirectoryIndex index.php
  Include /etc/apache2/conf-available/php{{ vhost.php_fpm }}-fpm.conf
{% endif %} {#- php_fpm #}

{% if vhost.documentroot is defined %}
  <Directory />
    Options +FollowSymLinks
    AllowOverride None
  </Directory>
  <Directory "{{ vhost.documentroot }}/.git">
    AllowOverride None
    Require all denied
  </Directory>
  AccessFileName .htaccess
  <Files ~ "^\.ht">
    Require all denied
  </Files>
  <Files ~ "^apple-touch.*\.png">
    Require all denied
  </Files>
  <Files ~ "\.cgi$">
    Require all denied
  </Files>

  <Directory "{{ vhost.documentroot }}">
    AllowOverride {{ vhost.allow_override | default(apache_allow_override) }}
    Options {{ vhost.options | default(apache_options) }}
    Require all granted

{% if vhost.is_drupal is defined and vhost.is_drupal %}
  <IfModule mod_rewrite.c>
    RewriteEngine On
    # Rewrite URLs of the form 'x' to the form 'index.php?q=x'.
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} !=/favicon.ico
    RewriteRule ^(.*)$          index.php?q=$1          [L,QSA]
  </IfModule>
{% endif -%}
  </Directory>

{% else %} {#- not documentroot #}

{% endif %} {#- documentroot #}
{% endif %} {#- not redirectssl #}

{% if vhost.extra_parameters is defined %}
{{ vhost.extra_parameters | indent(width=2, first=True) }}
{% endif -%} {#- extra #}

</VirtualHost>
